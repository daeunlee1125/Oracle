/*
    날짜 : 2025/07/23
    이름 : 이다은
    내용 : SQL 연습문제4
*/

-- 실습 4-1
ALTER SESSION SET "_ORACLE_SCRIPT"=true;
CREATE USER library IDENTIFIED BY 1234;
GRANT CONNECT, RESOURCE, UNLIMITED TABLESPACE TO library;
exit;

-- 실습 4-2
create table Member(
    member_id NUMBER(4) primary key,
    name VARCHAR2(40) not null,
    address VARCHAR2(100) default null,
    hp CHAR(13) default null,
    join_date DATE not null
);

create table Book(
    book_Id NUMBER(5) primary key,
    title VARCHAR2(50) not null,
    author VARCHAR2(40) not null,
    publisher VARCHAR2(40) not null,
    available CHAR(1) default null,
    reg_date DATE not null
);

create table Loan(
    loan_Id NUMBER generated by default as IDENTITY primary key,
    member_Id NUMBER(4) not null,
    book_Id NUMBER(5) not null,
    loan_date DATE default null,
    return_date DATE default null,
    actual_date DATE default null,
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK (BOOK_ID),
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER (MEMBER_ID)
);


-- 실습 4-3
INSERT into Member values (1001, '김유신', '서울특별시 강남구 역삼동', '010-1234-1001', '2024-01-10 09:15:00');
INSERT into Member values (1002, '김춘추', '대전광역시 유성구 장대동', '010-1234-1002', '2024-02-14 14:30:45');
INSERT into Member values (1003, '장보고', '대구광역시 수성구 반월동', '010-1234-1003', '2024-03-01 11:05:20');
INSERT into Member values (1004, '강감찬', '부산광역시 금정구 부곡동', '010-1234-1004', '2024-03-22 16:40:00');
INSERT into Member values (1005, '이순신', '광주광역시 광산구 우산동', '010-1234-1005', '2024-04-10 08:50:10');

INSERT into Book values (10001, '태백산맥', '조정래', '문학수첩', 'Y', '2014-01-10 09:15:00');
INSERT into Book values (10002, '데미안', '헤르만 헤세', '민음사', 'N', '2014-02-14 14:30:45');
INSERT into Book values (10003, '토지', '박경리', '문학사상사', 'Y', '2014-03-01 11:05:20');
INSERT into Book values (10004, '명품 자바 프로그래밍', '제임스 고슬링', '한빛출판사', 'Y', '2014-03-22 16:40:00');
INSERT into Book values (10005, '로미오와 줄리엣', '세익스피어', '열린책들', 'N', '2014-04-10 08:50:10');
INSERT into Book values (10006, '삼국지', '나관중', '민음사', 'Y', '2014-04-05 09:12:02');
INSERT into Book values (10007, '칼의 노래', '김훈', '문학동네', 'Y', '2014-06-10 12:53:17');
INSERT into Book values (10008, '데이터베이스', '래리 엘리슨', '한빛출판사', 'N', '2014-05-23 10:13:09');
INSERT into Book values (10009, 'Linux 운영체제', '리누스 토발즈', '한빛출판사', 'Y', '2014-03-11 11:23:43');
INSERT into Book values (10010, '어린 왕자', '생텍쥐베리', '열린책들', 'Y', '2014-05-13 15:27:21');


INSERT into Loan values (1, 1001, 10002, '2024-03-01 10:02:31', '2024-03-15 10:02:31', '2024-03-13 09:44:19');
INSERT into Loan values (2, 1002, 10004, '2024-03-05 15:10:02', '2024-03-19 15:10:02', '2024-03-12 17:12:30');
INSERT into Loan values (3, 1003, 10008, '2024-04-01 11:01:12', '2024-04-15 11:01:12', NULL);
INSERT into Loan values (4, 1002, 10001, '2024-04-10 14:32:01', '2024-04-24 14:32:01', '2024-04-22 13:56:32');
INSERT into Loan values (5, 1005, 10004, '2024-04-15 16:24:21', '2024-04-29 16:24:21', NULL);
INSERT into Loan values (6, 1004, 10006, '2024-05-01 09:12:09', '2024-05-15 09:12:09', '2024-05-14 09:21:27');
INSERT into Loan values (7, 1001, 10007, '2024-05-03 13:51:07', '2024-05-17 13:51:07', '2024-05-16 14:05:10');
INSERT into Loan values (8, 1003, 10009, '2024-06-01 11:15:43', '2024-06-15 11:15:43', NULL);
INSERT into Loan values (9, 1004, 10004, '2024-06-02 12:30:52', '2024-06-16 12:30:52', NULL);
INSERT into Loan values (10, 1002, 10008, '2024-06-05 10:06:17', '2024-06-19 10:06:17', NULL);

-- 실습 4-4
SELECT * FROM MEMBER;

-- 실습 4-5
SELECT title, author FROM BOOK;

-- 실습 4-6
SELECT name, address FROM MEMBER
WHERE ADDRESS LIKE '부산%';

-- 실습 4-7
SELECT title FROM BOOK
WHERE AVAILABLE='Y';

-- 실습 4-8
SELECT * FROM BOOK
WHERE BOOK_ID=10005;

-- 실습 4-9
SELECT MEMBER_ID, NAME, hp FROM MEMBER
WHERE MEMBER_ID=1002;

-- 실습 4-10
/*방법 1*/
SELECT title FROM BOOK
WHERE REG_DATE LIKE '2014-03%';

/*방법 2*/
SELECT TITLE FROM BOOK
WHERE REG_DATE BETWEEN '2014-03-01' AND '2014-03-31';

-- 실습 4-11
SELECT title, author, publisher FROM BOOK
WHERE PUBLISHER='민음사';

-- 실습 4-12
SELECT loan_id, member_id, book_id FROM LOAN
WHERE actual_date is null;

-- 실습 4-13
SELECT * FROM MEMBER
WHERE NAME LIKE '김%';

-- 실습 4-14
/*방법1*/
SELECT name, address FROM MEMBER
WHERE ADDRESS LIKE '부산%'
    OR ADDRESS LIKE '대구%';
/*방법2*/    
SELECT name, address FROM MEMBER
WHERE SUBSTR(address, 1, 2) in ('대구', '부산');

-- 실습 4-15
SELECT book_id, title FROM BOOK
WHERE BOOK_ID IN (10003, 10006);

-- 실습 4-16
SELECT title, author FROM BOOK
WHERE AUTHOR IN ('조정래', '박경리');

-- 실습 4-17 ***
SELECT name, join_date FROM MEMBER
WHERE JOIN_DATE <= '2024-04-01';
    
-- 실습 4-18
SELECT loan_id, member_id, book_id, loan_date FROM LOAN
WHERE LOAN_DATE >= '2024-05-01';

-- 실습 4-19
SELECT title, author, publisher FROM BOOK
WHERE AVAILABLE='N';

-- 실습 4-20
SELECT * FROM BOOK
WHERE TITLE LIKE '%자바%';

-- 실습 4-21
SELECT name, hp FROM MEMBER
WHERE HP != '010-1234-1003';

-- 실습 4-22
SELECT loan_id, member_id, book_id FROM LOAN
WHERE RETURN_DATE <= '2024-03-20';

-- 실습 4-23
SELECT * FROM MEMBER
ORDER BY NAME ASC;

-- 실습 4-24
SELECT title, reg_date FROM BOOK
ORDER BY reg_date DESC;

-- 실습 4-25
SELECT title FROM BOOK
ORDER BY TITLE ASC
FETCH FIRST 3 ROWS ONLY;

-- 실습 4-26
SELECT * FROM MEMBER
ORDER BY join_date DESC
FETCH FIRST 1 ROW ONLY;

-- 실습 4-27
SELECT loan_id, loan_date FROM LOAN
ORDER BY loan_date ASC
FETCH FIRST 2 ROWS ONLY;

-- 실습 4-28
SELECT COUNT(*) FROM MEMBER;

-- 실습 4-29
SELECT COUNT(*) FROM BOOK;

-- 실습 4-30
SELECT COUNT(*) FROM BOOK
WHERE AVAILABLE='Y';

-- 실습 4-31
SELECT publisher, COUNT(*) AS 출판_도서수 FROM BOOK
GROUP BY PUBLISHER;

-- 실습 4-32
SELECT COUNT(*) FROM LOAN
WHERE LOAN_DATE LIKE '2024%';

-- 실습 4-33
SELECT member_id, count(*) as 대출_도서수 FROM LOAN
GROUP BY MEMBER_ID;

-- 실습 4-34
SELECT book_id, count(*) as 대출횟수 FROM LOAN
GROUP BY BOOK_ID;

-- 실습 4-35
SELECT member_id, count(*) as 회원_대출건수 FROM LOAN
GROUP BY MEMBER_ID
HAVING COUNT(*)>=2;

-- 실습 4-36
SELECT book_id, count(*) as 도서_대출건수 FROM LOAN
GROUP BY BOOK_ID
HAVING COUNT(*)>=2;

-- 실습 4-37 ***
SELECT 
    MEMBER_ID, NAME,
    BOOK_ID, TITLE,
    LOAN_DATE
FROM LOAN l
JOIN BOOK b USING (BOOK_ID)
JOIN MEMBER m USING (MEMBER_ID); 

-- 실습 4-38
SELECT name, count(*) FROM MEMBER m
INNER JOIN LOAN l USING (MEMBER_ID)
GROUP BY name
HAVING count(*)>=3;

-- 실습 4-39
SELECT 
    loan_id,
    name,
    title,
    loan_date
FROM LOAN
INNER JOIN MEMBER using (MEMBER_ID)
INNER JOIN BOOK using (BOOK_ID)
WHERE LOAN_DATE <= TO_DATE('2024-05-01');

-- 실습 4-40
SELECT TITLE FROM LOAN
INNER JOIN BOOK USING (BOOK_ID)
INNER JOIN MEMBER USING (MEMBER_ID)
WHERE NAME='김유신';

-- 실습 4-41
SELECT name FROM LOAN
INNER JOIN BOOK USING (BOOK_ID)
INNER JOIN MEMBER USING (MEMBER_ID)
WHERE TITLE='태백산맥';

-- 실습 4-42
SELECT name, title FROM LOAN
INNER JOIN BOOK USING (BOOK_ID)
INNER JOIN MEMBER USING (MEMBER_ID)
WHERE name='김춘추'
order by title asc;

-- 실습 4-43
SELECT title, name FROM LOAN
INNER JOIN BOOK USING (BOOK_ID)
INNER JOIN MEMBER USING (MEMBER_ID)
WHERE LOAN_DATE LIKE '2024-04%';

-- 실습 4-44
SELECT name, title FROM LOAN
INNER JOIN MEMBER using (MEMBER_ID)
INNER JOIN BOOK using (BOOK_ID)
WHERE ACTUAL_DATE is null;

-- 실습 4-45
SELECT name, title FROM LOAN
INNER JOIN MEMBER using (MEMBER_ID)
INNER JOIN BOOK using (BOOK_ID)
where author='조정래';

-- 실습 4-46 ***
SELECT book_id, title FROM book
left JOIN loan using (book_id)
where loan_date is null;

-- 실습 4-47
SELECT name, count(*) FROM MEMBER
JOIN LOAN USING (MEMBER_ID)
GROUP BY NAME
ORDER BY count(*) DESC;

-- 실습 4-48 ***
/*SELECT NAME FROM MEMBER
JOIN LOAN USING (MEMBER_ID)
GROUP BY NAME
ORDER BY COUNT(*) DESC
FETCH FIRST 1 ROW ONLY;*/
SELECT * FROM MEMBER
where member_id=( --서브쿼리 시작
    select member_id from loan
    group by member_id
    order by count(*) desc
    fetch first 1 row only);

-- 실습 4-49
SELECT TITLE FROM BOOK
WHERE PUBLISHER = (
        SELECT PUBLISHER FROM BOOK 
        WHERE TITLE='데이터베이스')
    AND TITLE != '데이터베이스';
                    

-- 실습 4-50
SELECT NAME FROM MEMBER
WHERE member_id IN (
    SELECT member_id FROM loan
    WHERE book_id = 10004
);